@model AfReparosAutomotivos.Models.OrcamentosViewModel

@{
    ViewData["Title"] = "Cadastrar Orçamento";
    var customHeaderColor = "#3b2e1a"; 
}

<div class="container mt-5">
    <div class="card shadow-lg rounded-4 border-0">
        <div class="card-header text-white text-center rounded-top-4" style="background-color: @customHeaderColor">
            <h3 class="mb-0">Cadastrar Orçamento</h3>
        </div>

        <div class="card-body p-4">
            <form asp-action="Create">
                <div asp-validation-summary="ModelOnly" class="text-danger mb-4"></div>

                <div class="row g-4">
                    <fieldset class="border p-3 rounded-3 mb-4">
                        <legend class="float-none w-auto px-2 fs-6 fw-bold text-muted">Dados do Cliente</legend>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="DocumentoCli" class="form-label fw-semibold">Documento do Cliente</label>
                                <div class="input-group">
                                    <input asp-for="DocumentoCli" id="documentoCliente" type="text" class="form-control" 
                                        placeholder="Apenas números (11 ou 14 dígitos)" 
                                        maxlength="14" minlength="11"
                                        oninput="this.value = this.value.replace(/[^0-9]/g,'')">
                                    <button type="button" class="btn btn-outline-secondary" id="btnPesquisarCliente">
                                        <i class="fas fa-search"></i> Pesquisar
                                    </button>
                                </div>
                                <span asp-validation-for="DocumentoCli" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="nome" class="form-label fw-semibold">Nome do Cliente</label>
                                <input asp-for="nome" id="nomeCliente" type="text" class="form-control" required />
                                <span asp-validation-for="nome" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="TelefoneCli" class="form-label fw-semibold">Telefone do Cliente</label>
                                <input asp-for="TelefoneCli" id="telefoneCliente" type="text" class="form-control" maxlength="11" 
                                    placeholder="Apenas números (Ex: 11999998888)"
                                    required />
                                <span asp-validation-for="TelefoneCli" class="text-danger"></span>
                            </div> 
                            <div class="col-md-6">
                                <label asp-for="EnderecoCli" class="form-label fw-semibold">Endereço do Cliente</label>
                                <input asp-for="EnderecoCli" id="enderecoCliente" type="text" class="form-control"
                                    placeholder="Ex: Rua João, número 3, São José do Rio Preto - SP" required/>
                                <span asp-validation-for="EnderecoCli" class="text-danger"></span>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset class="border p-3 rounded-3 mb-4">
                        <legend class="float-none w-auto px-2 fs-6 fw-bold text-muted">Dados do Veículo</legend>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="Placa" class="form-label fw-semibold">Placa do Veículo</label>
                                <div class="input-group">
                                    <input asp-for="Placa" type="text" class="form-control" id="Placa" placeholder="Ex: ABC1234" required maxlength="7"/>
                                    <button type="button" class="btn btn-outline-secondary" id="btnPesquisarVeiculo">
                                        <i class="fas fa-search"></i> Pesquisar
                                    </button>
                                </div>
                                <span asp-validation-for="Placa" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Marca" class="form-label fw-semibold">Marca</label>
                                <input asp-for="Marca" type="text" class="form-control" id="Marca" placeholder="Ex: Fiat" required />
                                <span asp-validation-for="Marca" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Modelo" class="form-label fw-semibold">Modelo</label>
                                <input asp-for="Modelo" type="text" class="form-control" id="Modelo" placeholder="Ex: Palio" required/>
                                <span asp-validation-for="Modelo" class="text-danger"></span>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset class="border p-3 rounded-3">
                        <legend class="float-none w-auto px-2 fs-6 fw-bold text-muted">Detalhes do Orçamento</legend>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="dataCriacao" class="form-label fw-semibold">Data de Criação</label>
                                <input asp-for="dataCriacao" type="datetime-local" class="form-control" required readonly
                                    value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")">
                                <span asp-validation-for="dataCriacao" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="dataEntrega" class="form-label fw-semibold">Data de Entrega</label>
                                <input asp-for="dataEntrega" type="date" class="form-control">
                                <span asp-validation-for="dataEntrega" class="text-danger"></span>
                            </div>
                            <!-- NOVO CAMPO SELECT PARA SERVIÇOS -->
                            <div class="col-md-12">
                                <label asp-for="IdServico" class="form-label fw-semibold">Selecione o Serviço</label>
                                <select asp-for="IdServico" 
                                        class="form-control" 
                                        asp-items="@Model.ServicosDisponiveis" 
                                        required>
                                    <option value="">-- Selecione um Serviço --</option>
                                </select>
                                <span asp-validation-for="IdServico" class="text-danger"></span>
                            </div>
                            <!-- FIM DO NOVO CAMPO SELECT -->
                            <div class="col-md-6">
                                <label asp-for="status" class="form-label fw-semibold">Status</label>
                                <select asp-for="status" class="form-control" required>
                                    <option value="1">1 - Em Aberto</option>
                                    <option value="2">2 - Pago</option>
                                    <option value="3">3 - Cancelado</option>
                                </select>
                                <span asp-validation-for="status" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="total" class="form-label fw-semibold">Valor Total</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input asp-for="total" type="text" class="form-control" placeholder="Ex: 250,00"
                                        asp-format="{0:N2}" step="0.01" inputmode="decimal" required>
                                </div>
                                <span asp-validation-for="total" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="formaPagamento" class="form-label fw-semibold">Forma de Pagamento</label>
                                <input asp-for="formaPagamento" type="text" class="form-control"
                                    placeholder="Cartão, PIX, ..." required>
                                <span asp-validation-for="formaPagamento" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="parcelas" class="form-label fw-semibold">Parcelas</label>
                                <input asp-for="parcelas" type="number" class="form-control" min="1" step="1" required>
                                <span asp-validation-for="parcelas" class="text-danger"></span>
                            </div>
                        </div>
                    </fieldset>
                </div>

                <div class="d-flex justify-content-end gap-3 mt-4">
                    <a asp-action="Index" class="btn btn-outline-secondary px-4">Voltar</a>
                    <button type="submit" class="btn-login">Criar</button>
                </div>
            </form>
        </div>
    </div>
</div>
@section Scripts
{
    <script>
        function preencherDadosCliente(cliente) {
            document.getElementById('nomeCliente').value = cliente.nome || '';
            document.getElementById('telefoneCliente').value = cliente.telefone || '';
            document.getElementById('enderecoCliente').value = cliente.endereco || '';
        }

        document.getElementById('btnPesquisarCliente').addEventListener('click', function() {
            var documento = document.getElementById('documentoCliente').value;
            
            if (documento.length !== 11 && documento.length !== 14) {
                alert('Por favor, digite um CPF (11 dígitos) ou CNPJ (14 dígitos) válido para a pesquisa.');
                return;
            }

            fetch('/Orcamentos/PesquisarCliente?documento=' + documento)
                .then(resposta => {
                    if (!resposta.ok) {
                        throw new Error('Erro na rede ou ao buscar o cliente.');
                    }
                    return resposta.json();
                })
                .then(data => {
                    if (data && data.id) { // Verifique se o cliente foi encontrado (usando 'id' ou 'idCliente')
                        preencherDadosCliente(data);
                    } else {
                        document.getElementById('nomeCliente').value = '';
                        document.getElementById('telefoneCliente').value = '';
                        document.getElementById('enderecoCliente').value = '';
                    }
                })
                .catch(error => {
                    console.error('Erro na pesquisa:', error);
                    alert('Ocorreu um erro ao tentar pesquisar o cliente.');
                });
        });
        
        function preencherDadosVeiculo(veiculo) {
            document.getElementById('Marca').value = veiculo.marca || '';
            document.getElementById('Modelo').value = veiculo.modelo || '';
        }

        document.getElementById('btnPesquisarVeiculo').addEventListener('click', function() {
            var placa = document.getElementById('Placa').value;
            
            if (placa.length !== 7) {
                alert('Por favor, digite uma placa válida para a pesquisa.');
                return;
            }

            fetch('/Orcamentos/PesquisarVeiculo?placa=' + placa)
                .then(resposta => {
                    if (!resposta.ok) {
                        throw new Error('Erro na rede ou ao buscar o veículo.');
                    }
                    return resposta.json();
                })
                .then(data => {
                    if (data && data.id) {
                        preencherDadosVeiculo(data);
                    } else {
                        document.getElementById('Marca').value = '';
                        document.getElementById('Modelo').value = '';
                    }
                })
                .catch(error => {
                    console.error('Erro na pesquisa:', error);
                    alert('Ocorreu um erro ao tentar pesquisar o veículo.');
                });
        });

        @if (TempData["Mensagem"] is string jsonMessage)
        {
            var modal = System.Text.Json.JsonSerializer.Deserialize<Modal>(jsonMessage);
            <partial name="_Modal" model="modal"/>
            <script>
                document.addEventListener('DOMContentLoaded', function ()
                {
                    showGenericModal('@modal?.Id');
                });
            </script>
        }
    </script>
} 